# 实现计划：管理员充值收款码配置

## 概述

本实现计划将完善系统的充值收款码配置功能，确保管理员能够上传和配置二维码，用户能够在充值时看到正确的收款码。实现将分为数据库设置、API 层完善、组件功能增强和测试四个主要部分。

## 任务

- [x] 1. 设置 Supabase 数据库和存储
  - [x] 1.1 创建 system_config 表
    - 在 Supabase Dashboard 中执行 SQL 创建表
    - 添加字段：id (uuid), key (text, unique), value (jsonb), created_at, updated_at
    - 创建唯一索引和自动更新触发器
    - _需求：0.1, 0.2, 0.3, 0.5_
  
  - [x] 1.2 创建 qr-codes 存储桶
    - 在 Supabase Storage 中创建名为 'qr-codes' 的 bucket
    - 配置为 public bucket（公开访问）
    - 设置文件大小限制为 5MB
    - 配置允许的文件类型为 image/*
    - _需求：0.1.1, 0.1.2, 0.1.3, 0.1.4_
  
  - [x] 1.3 配置存储桶访问策略
    - 创建 Policy 允许认证用户上传
    - 创建 Policy 允许公开读取
    - 创建 Policy 允许认证用户删除
    - _需求：8.1, 8.2_

- [x] 2. 完善 API 服务层文件验证
  - [x] 2.1 添加文件验证工具函数
    - 在 services/supabase.ts 中创建 validateFile 函数
    - 实现文件格式验证（MIME 类型检查）
    - 实现文件大小验证（5MB 限制）
    - 返回验证结果和具体错误消息
    - _需求：1.1, 7.1, 7.2, 7.3, 7.5_
  
  - [ ]* 2.2 为文件验证编写属性测试
    - **属性 2：文件格式验证**
    - **验证：需求 1.1, 7.3, 7.5**
  
  - [ ]* 2.3 为文件大小限制编写属性测试
    - **属性 3：文件大小限制**
    - **验证：需求 7.1, 7.2**

- [x] 3. 优化 uploadImage 方法
  - [x] 3.1 更新 uploadImage 实现
    - 在上传前调用 validateFile 进行验证
    - Mock 模式：确保 Base64 转换正确处理所有图片格式
    - Supabase 模式：使用唯一文件名（recharge_qr_{timestamp}.{ext}）
    - Supabase 模式：上传到 'qr-codes' bucket 而不是 'pic'
    - 添加详细的错误处理和错误消息
    - _需求：1.2, 3.2, 4.1, 4.2, 0.1.5_
  
  - [ ]* 3.2 为图片上传编写属性测试
    - **属性 4：图片上传返回有效 URL**
    - **验证：需求 1.2, 3.2, 4.2**
  
  - [ ]* 3.3 为唯一文件名生成编写属性测试
    - **属性 20：唯一文件名生成**
    - **验证：需求 0.1.5**

- [x] 4. 优化配置存储方法
  - [x] 4.1 更新 saveSystemConfig 实现
    - 确保 Mock 模式正确使用 localStorage
    - 确保 Supabase 模式使用 UPSERT 操作
    - 添加 localStorage 降级策略（捕获异常，使用内存存储）
    - 改进错误处理，提供具体错误消息
    - _需求：1.3, 3.1, 3.3, 3.5, 4.3, 5.1_
  
  - [x] 4.2 更新 getSystemConfig 实现
    - 确保正确处理 null/undefined/空字符串
    - 确保正确去除 JSON 字符串的引号
    - 添加错误处理（静默失败，返回 null）
    - _需求：2.1, 4.4, 5.2, 5.3_
  
  - [ ]* 4.3 为配置往返一致性编写属性测试
    - **属性 1：配置往返一致性**
    - **验证：需求 1.3, 3.4, 4.4, 5.2**
  
  - [ ]* 4.4 为配置覆盖行为编写属性测试
    - **属性 5：配置覆盖行为**
    - **验证：需求 5.1**
  
  - [ ]* 4.5 为 Mock 模式存储机制编写属性测试
    - **属性 8：Mock 模式存储机制**
    - **验证：需求 3.1, 3.3**
  
  - [ ]* 4.6 为 localStorage 降级策略编写属性测试
    - **属性 14：localStorage 降级策略**
    - **验证：需求 3.5**

- [x] 5. 检查点 - 确保 API 层测试通过
  - 确保所有 API 层的单元测试和属性测试通过，如有问题请向用户提问。

- [x] 6. 完善 AdminDashboard 组件
  - [x] 6.1 添加初始加载二维码配置
    - 在 useEffect 中调用 api.getSystemConfig('recharge_qr')
    - 加载成功后设置 rechargeQrUrl 状态
    - 添加加载状态处理
    - _需求：1.5_
  
  - [x] 6.2 增强 handleQrUpload 函数
    - 在上传前调用 validateFile 验证文件
    - 验证失败时显示具体错误消息并返回
    - 添加图片尺寸检查（超过 2000x2000 显示警告但允许上传）
    - 改进错误处理，区分不同错误类型
    - 上传失败时保持当前配置不变
    - _需求：1.1, 1.4, 6.4, 6.5, 7.1, 7.2, 7.3, 7.4_
  
  - [x] 6.3 添加二维码预览功能
    - 在财务标签页显示当前配置的二维码
    - 如果未配置，显示占位文本
    - 添加"更换二维码"按钮
    - _需求：1.5_
  
  - [ ]* 6.4 为 AdminDashboard 上传流程编写单元测试
    - 测试文件验证逻辑
    - 测试上传成功和失败场景
    - 测试加载状态和错误消息显示
    - _需求：1.1, 1.4, 1.5, 6.4, 6.5_

- [x] 7. 完善 Wallet 组件
  - [x] 7.1 添加加载状态指示器
    - 添加 isLoadingQr 状态
    - 在 useEffect 加载期间设置为 true
    - 显示骨架屏或 spinner
    - _需求：2.5, 6.1_
  
  - [x] 7.2 改进二维码显示逻辑
    - 确保正确处理空配置（显示默认图）
    - 确保 onError 回退到默认图
    - 添加图片加载失败的日志
    - _需求：2.2, 2.3, 2.4, 5.4_
  
  - [x] 7.3 添加二维码点击放大功能
    - 点击二维码时显示全屏模态框
    - 模态框中显示大尺寸二维码
    - 添加关闭按钮
    - _需求：6.3_
  
  - [ ]* 7.4 为 Wallet 组件编写单元测试
    - 测试加载状态显示
    - 测试配置存在时显示二维码
    - 测试配置不存在时显示默认图
    - 测试图片加载失败时的回退
    - _需求：2.2, 2.3, 2.4, 2.5, 6.1_
  
  - [ ]* 7.5 为未配置状态处理编写属性测试
    - **属性 6：未配置状态处理**
    - **验证：需求 2.3, 5.3**
  
  - [ ]* 7.6 为错误时显示默认图编写属性测试
    - **属性 7：错误时显示默认图**
    - **验证：需求 2.4, 5.4**

- [x] 8. 检查点 - 确保组件测试通过
  - 确保所有组件的单元测试和属性测试通过，如有问题请向用户提问。

- [x] 9. 添加安全验证
  - [x] 9.1 实现管理员权限检查
    - 在 handleQrUpload 开始时检查 user.isAdmin
    - 非管理员用户显示权限错误并返回
    - _需求：8.1, 8.2_
  
  - [x] 9.2 添加文件内容验证
    - 在 validateFile 中添加文件头检查
    - 验证文件实际内容是图片（不仅检查 MIME 类型）
    - _需求：8.3_
  
  - [x] 9.3 添加 URL 安全验证
    - 创建 validateImageUrl 函数
    - 验证 URL 是 data URL 或指向 Supabase 域名
    - 在 getSystemConfig 返回前验证 URL
    - _需求：8.5_
  
  - [ ]* 9.4 为安全验证编写属性测试
    - **属性 17：管理员权限验证**
    - **属性 18：文件内容验证**
    - **属性 19：URL 安全验证**
    - **验证：需求 8.1, 8.2, 8.3, 8.5**

- [x] 10. 添加用户体验优化
  - [x] 10.1 改进错误消息
    - 为所有错误场景提供具体的错误消息
    - 区分网络错误、权限错误、验证错误等
    - 使用 onShowToast 显示友好提示
    - _需求：6.5_
  
  - [x] 10.2 添加上传进度反馈
    - 在 AdminDashboard 中显示上传进度
    - 使用 isUploadingQr 状态控制按钮禁用
    - 显示"上传中..."文本
    - _需求：1.5, 6.4_
  
  - [ ]* 10.3 为用户体验编写单元测试
    - 测试错误消息的具体性
    - 测试加载状态的正确显示
    - 测试上传进度反馈
    - _需求：1.5, 6.4, 6.5_

- [ ] 11. 集成测试
  - [ ]* 11.1 编写管理员上传流程集成测试
    - 测试完整的上传流程
    - 从文件选择到配置保存
    - 验证 UI 状态更新
    - _需求：1.1, 1.2, 1.3, 1.4, 1.5_
  
  - [ ]* 11.2 编写用户充值流程集成测试
    - 测试完整的充值流程
    - 从打开钱包到显示二维码
    - 验证配置加载和显示
    - _需求：2.1, 2.2, 2.3, 2.4, 2.5_
  
  - [ ]* 11.3 编写模式切换集成测试
    - 测试 Mock 模式和 Supabase 模式
    - 验证两种模式下的行为一致性
    - _需求：3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3, 4.4_

- [x] 12. 最终检查点 - 完整功能验证
  - 确保所有测试通过（单元测试、属性测试、集成测试）
  - 在 Mock 模式下手动测试完整流程
  - 在 Supabase 模式下手动测试完整流程
  - 验证所有需求的验收标准
  - 如有问题请向用户提问

## 注意事项

- 标记为 `*` 的任务是可选的测试任务，可以根据项目进度决定是否实施
- 每个任务都引用了相关的需求编号，便于追溯
- 属性测试应使用 fast-check 库，每个测试至少运行 100 次
- 所有测试应包含标签注释，格式：`Feature: admin-recharge-qr-config, Property {N}: {property_text}`
- 实现过程中如遇到问题，应在检查点任务处暂停并向用户提问
